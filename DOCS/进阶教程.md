# Unity 框架进阶教程

## 写在前面

恭喜你完成了新手入门！现在你已经掌握了框架的基本用法：如何加载资源、如何使用对象池、如何发送事件、如何制作UI等。

但是，游戏的实际开发往往需要**多个模块协同工作**。比如：
- 制作一个敌人AI需要：状态机 + 事件系统 + 对象池 + 定时器
- 制作一个成就系统需要：事件系统 + 数据存储 + UI管理 + 资源加载

这篇教程会告诉你：**哪些模块应该组合在一起使用**，以及**如何组合**，帮助你做出完整的游戏功能。

---

## 目录

- [模块组合原则](#模块组合原则)
- [功能组合示例](#功能组合示例)
  - [组合1：敌人AI系统](#组合1敌人ai系统)
  - [组合2：成就与统计系统](#组合2成就与统计系统)
  - [组合3：技能系统](#组合3技能系统)
  - [组合4：存档与读档](#组合4存档与读档)
  - [组合5：商城系统](#组合5商城系统)
  - [组合6：任务系统](#组合6任务系统)
  - [组合7：新手引导系统](#组合7新手引导系统)
  - [组合8：公告与活动系统](#组合8公告与活动系统)
  - [组合9：每日奖励系统](#组合9每日奖励系统)
  - [组合10：排行榜系统](#组合10排行榜系统)
- [模块搭配速查表](#模块搭配速查表)
- [进阶技巧](#进阶技巧)

---

## 模块组合原则

### 核心思想

在游戏开发中，没有一个功能是孤立存在的。每个功能都需要多个模块配合完成：

```
┌─────────────────────────────────────────────────────────────┐
│                        游戏功能                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  数据管理 │  │  资源加载 │  │  UI显示  │  │  音频播放 │   │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘   │
│       │             │             │             │          │
│       └─────────────┴─────────────┴─────────────┘          │
│                         │                                    │
│                    ┌────┴────┐                              │
│                    │ 事件系统 │                              │
│                    └────┬────┘                              │
│                         │                                    │
│       ┌─────────────────┴─────────────────┐                 │
│       │             业务逻辑              │                 │
│       └──────────────────────────────────┘                 │
└─────────────────────────────────────────────────────────────┘
```

### 组合模式

**模式1：数据驱动UI**
```
数据变化 → 事件通知 → UI响应更新
需要：ResMgr（加载UI资源） + EventCenter（通知） + UIMgr（显示）
```

**模式2：资源池化**
```
需要时获取 → 用完归还 → 循环使用
需要：PoolMgr（对象池） + ResMgr/ABMgr（资源加载）
```

**模式3：时间驱动**
```
定时触发 → 执行逻辑 → 状态更新
需要：TimerMgr（定时） + 业务逻辑 + EventCenter（通知）
```

**模式4：输入响应**
```
玩家输入 → 事件触发 → 逻辑执行 → 结果反馈
需要：InputMgr（输入） + EventCenter（事件） + 业务逻辑 + MusicMgr/Sound + UI反馈
```

---

## 功能组合示例

### 组合1：敌人AI系统

**功能描述**：敌人能够自动巡逻、追击玩家、攻击玩家、被击败后回收。

**涉及模块**：
- `PoolMgr` - 敌人对象池
- `TimerMgr` - 巡逻时间控制
- `EventCenter` - 事件通知
- `MonoMgr` - 每帧AI判断
- `BaseManager<T>` - 敌人管理器

**实现代码**：

```csharp
// ==================== 敌人管理器 ====================
public class EnemyManager : BaseManager<EnemyManager>
{
    private EnemyManager() { }
    
    // 生成敌人
    public Enemy SpawnEnemy(Vector3 position, int level)
    {
        Enemy enemy = PoolMgr.Instance.GetObj<Enemy>("Enemy");
        enemy.Init(position, level);
        return enemy;
    }
    
    // 回收敌人
    public void DespawnEnemy(Enemy enemy)
    {
        PoolMgr.Instance.PushObj(enemy);
    }
    
    // 预热对象池
    public void Prewarm(int count = 10)
    {
        for (int i = 0; i < count; i++)
        {
            var enemy = PoolMgr.Instance.GetObj<Enemy>("Enemy");
            PoolMgr.Instance.PushObj(enemy);
        }
    }
}

// ==================== 敌人状态接口 ====================
public interface IEnemyState
{
    void OnEnter(Enemy enemy);
    void OnUpdate(Enemy enemy);
    void OnExit(Enemy enemy);
}

// ==================== 敌人状态机 ====================
public class EnemyStateMachine
{
    private IEnemyState currentState;
    private Dictionary<EnemyStateType, IEnemyState> states = new Dictionary<EnemyStateType, IEnemyState>();
    
    public void AddState(EnemyStateType type, IEnemyState state)
    {
        states[type] = state;
    }
    
    public void ChangeState(EnemyStateType type, Enemy enemy)
    {
        currentState?.OnExit(enemy);
        
        if (states.TryGetValue(type, out IEnemyState newState))
        {
            currentState = newState;
            currentState.OnEnter(enemy);
        }
    }
    
    public void Update(Enemy enemy)
    {
        currentState?.OnUpdate(enemy);
    }
}

// ==================== 敌人状态类型 ====================
public enum EnemyStateType
{
    Idle,       // 待机
    Patrol,     // 巡逻
    Chase,      // 追击
    Attack,     // 攻击
    Hurt,       // 受击
    Die,        // 死亡
}

// ==================== 待机状态 ====================
public class IdleState : IEnemyState
{
    private float waitTime;
    private float timer;
    
    public void OnEnter(Enemy enemy)
    {
        timer = 0;
        waitTime = Random.Range(1f, 3f);
        enemy.animator.Play("Idle");
    }
    
    public void OnUpdate(Enemy enemy)
    {
        timer += Time.deltaTime;
        
        // 检测玩家
        if (DetectPlayer(enemy))
        {
            enemy.stateMachine.ChangeState(EnemyStateType.Chase, enemy);
            return;
        }
        
        // 等待结束，进入巡逻
        if (timer >= waitTime)
        {
            enemy.stateMachine.ChangeState(EnemyStateType.Patrol, enemy);
        }
    }
    
    public void OnExit(Enemy enemy) { }
    
    private bool DetectPlayer(Enemy enemy)
    {
        float distance = Vector3.Distance(enemy.transform.position, Player.Instance.transform.position);
        return distance < enemy.detectRange;
    }
}

// ==================== 巡逻状态 ====================
public class PatrolState : IEnemyState
{
    private Vector3[] patrolPoints;
    private int currentIndex;
    private float arriveDistance = 1f;
    
    public void OnEnter(Enemy enemy)
    {
        enemy.animator.Play("Run");
        
        // 设置巡逻点
        patrolPoints = GeneratePatrolPoints(enemy.transform.position, 10f, 4);
        currentIndex = 0;
    }
    
    public void OnUpdate(Enemy enemy)
    {
        // 移动到目标点
        Vector3 target = patrolPoints[currentIndex];
        enemy.transform.position = Vector3.MoveTowards(
            enemy.transform.position, 
            target, 
            enemy.moveSpeed * Time.deltaTime
        );
        enemy.transform.LookAt(target);
        
        // 到达目标点
        if (Vector3.Distance(enemy.transform.position, target) < arriveDistance)
        {
            currentIndex = (currentIndex + 1) % patrolPoints.Length;
        }
        
        // 检测玩家
        if (DetectPlayer(enemy))
        {
            enemy.stateMachine.ChangeState(EnemyStateType.Chase, enemy);
        }
    }
    
    public void OnExit(Enemy enemy) { }
    
    private Vector3[] GeneratePatrolPoints(Vector3 center, float radius, int count)
    {
        Vector3[] points = new Vector3[count];
        for (int i = 0; i < count; i++)
        {
            float angle = i * (360f / count);
            Vector3 offset = Quaternion.Euler(0, angle, 0) * Vector3.forward * radius;
            points[i] = center + offset;
        }
        return points;
    }
    
    private bool DetectPlayer(Enemy enemy)
    {
        float distance = Vector3.Distance(enemy.transform.position, Player.Instance.transform.position);
        return distance < enemy.detectRange;
    }
}

// ==================== 追击状态 ====================
public class ChaseState : IEnemyState
{
    public void OnEnter(Enemy enemy)
    {
        enemy.animator.Play("Run");
        // 播放追击音效
        MusicMgr.Instance.PlaySound("enemy_chase");
    }
    
    public void OnUpdate(Enemy enemy)
    {
        Vector3 playerPos = Player.Instance.transform.position;
        
        float distance = Vector3.Distance(enemy.transform.position, playerPos);
        
        if (distance < enemy.attackRange)
        {
            enemy.stateMachine.ChangeState(EnemyStateType.Attack, enemy);
        }
        else if (distance > enemy.loseRange)
        {
            enemy.stateMachine.ChangeState(EnemyStateType.Patrol, enemy);
        }
        else
        {
            // 追击玩家
            enemy.transform.position = Vector3.MoveTowards(
                enemy.transform.position,
                playerPos,
                enemy.chaseSpeed * Time.deltaTime
            );
            enemy.transform.LookAt(playerPos);
        }
    }
    
    public void OnExit(Enemy enemy) { }
}

// ==================== 攻击状态 ====================
public class AttackState : IEnemyState
{
    private float attackInterval = 1.5f;
    private float timer;
    
    public void OnEnter(Enemy enemy)
    {
        timer = attackInterval;
        enemy.animator.Play("Attack");
    }
    
    public void OnUpdate(Enemy enemy)
    {
        timer -= Time.deltaTime;
        
        if (timer <= 0)
        {
            // 攻击玩家
            Player.Instance.TakeDamage(enemy.attackDamage);
            
            // 播放攻击音效
            MusicMgr.Instance.PlaySound("enemy_attack");
            
            // 重置计时器
            timer = attackInterval;
        }
        
        // 检查是否需要切换状态
        float distance = Vector3.Distance(enemy.transform.position, Player.Instance.transform.position);
        if (distance > enemy.attackRange)
        {
            enemy.stateMachine.ChangeState(EnemyStateType.Chase, enemy);
        }
    }
    
    public void OnExit(Enemy enemy) { }
}

// ==================== 受伤状态 ====================
public class HurtState : IEnemyState
{
    private float hurtDuration = 0.3f;
    private float timer;
    
    public void OnEnter(Enemy enemy)
    {
        timer = hurtDuration;
        enemy.animator.Play("Hurt");
        MusicMgr.Instance.PlaySound("enemy_hurt");
    }
    
    public void OnUpdate(Enemy enemy)
    {
        timer -= Time.deltaTime;
        
        if (timer <= 0)
        {
            enemy.stateMachine.ChangeState(EnemyStateType.Chase, enemy);
        }
    }
    
    public void OnExit(Enemy enemy) { }
}

// ==================== 死亡状态 ====================
public class DieState : IEnemyState
{
    public void OnEnter(Enemy enemy)
    {
        enemy.animator.Play("Die");
        MusicMgr.Instance.PlaySound("enemy_die");
        
        // 延迟回收
        TimerMgr.Instance.CreateTimer(
            isRealTime: false,
            allTime: 2000,
            overCallBack: () => EnemyManager.Instance.DespawnEnemy(enemy)
        );
    }
    
    public void OnUpdate(Enemy enemy) { }
    
    public void OnExit(Enemy enemy) { }
}

// ==================== 敌人主脚本 ====================
public class Enemy : MonoBehaviour, IPoolObject
{
    public int level = 1;
    public float moveSpeed = 3f;
    public float chaseSpeed = 5f;
    public float detectRange = 10f;
    public float attackRange = 2f;
    public float loseRange = 15f;
    public int attackDamage = 10;
    public int hp = 100;
    public int maxHp = 100;
    
    [HideInInspector]
    public EnemyStateMachine stateMachine;
    [HideInInspector]
    public Animator animator;
    
    private bool isDead = false;
    
    private void Awake()
    {
        animator = GetComponent<Animator>();
        stateMachine = new EnemyStateMachine();
        
        // 初始化状态
        stateMachine.AddState(EnemyStateType.Idle, new IdleState());
        stateMachine.AddState(EnemyStateType.Patrol, new PatrolState());
        stateMachine.ChangeState(EnemyStateType.Idle, this);
    }
    
    private void Update()
    {
        if (isDead) return;
        stateMachine.Update(this);
    }
    
    public void Init(Vector3 position, int level)
    {
        transform.position = position;
        this.level = level;
        this.hp = 100 + level * 20;
        this.maxHp = hp;
        this.isDead = false;
        gameObject.SetActive(true);
        
        // 重新初始化状态
        stateMachine.ChangeState(EnemyStateType.Idle, this);
    }
    
    public void TakeDamage(int damage)
    {
        if (isDead) return;
        
        hp -= damage;
        
        if (hp <= 0)
        {
            Die();
        }
        else
        {
            // 进入受伤状态
            stateMachine.ChangeState(EnemyStateType.Hurt, this);
            
            // 通知玩家得分
            int score = 100 + level * 10;
            EventCenter.Instance.EventTrigger<int>(E_GameEvent.E_Enemy_Killed, score);
        }
    }
    
    private void Die()
    {
        if (isDead) return;
        isDead = true;
        
        stateMachine.ChangeState(EnemyStateType.Die, this);
    }
    
    public void ResetInfo()
    {
        hp = 0;
        isDead = true;
        gameObject.SetActive(false);
    }
}

// 使用方法
public class GameExample : MonoBehaviour
{
    private void Start()
    {
        // 预热对象池
        EnemyManager.Instance.Prewarm(10);
    }
    
    private void Update()
    {
        // 按空格生成敌人
        if (Input.GetKeyDown(KeyCode.Space))
        {
            Vector3 spawnPos = new Vector3(Random.Range(-5f, 5f), 0, 5f);
            EnemyManager.Instance.SpawnEnemy(spawnPos, 1);
        }
    }
}
```

**组合说明**：

| 模块 | 用途 |
|------|------|
| PoolMgr | 敌人对象池，避免频繁创建销毁 |
| TimerMgr | 死亡延迟回收、攻击间隔计时 |
| EventCenter | 敌人死亡通知玩家得分 |
| MonoMgr | 全局AI更新（可选） |
| BaseManager | EnemyManager单例管理 |

---

### 组合2：成就与统计系统

**功能描述**：记录玩家达成的成就，统计游戏数据，在UI上展示。

**涉及模块**：
- `BaseManager<T>` - 成就管理器
- `EventCenter` - 事件监听
- `UIMgr` - UI显示
- `ResMgr` - 加载成就图标
- `PoolMgr` - 成就弹窗对象池
- `MusicMgr` - 成就达成音效

**实现代码**：

```csharp
// ==================== 成就定义 ====================
[System.Serializable]
public class Achievement
{
    public string id;
    public string title;
    public string description;
    public string iconName;
    public int targetValue;
    public AchievementType type;
    public bool isUnlocked;
    public int currentProgress;
    public int reward;
}

// 成就类型
public enum AchievementType
{
    KillEnemy,      // 击杀敌人数量
    CollectCoin,    // 收集金币数量
    PlayTime,       // 累计游戏时间
    LevelUp,        // 达到等级
    ClearStage,     // 通关关卡
    UseSkill,       // 技能使用次数
}

// ==================== 成就管理器 ====================
public class AchievementManager : BaseManager<AchievementManager>
{
    private AchievementManager() { }
    
    private Dictionary<string, Achievement> achievements = new Dictionary<string, Achievement>();
    private AchievementPopup currentPopup;
    
    public void Initialize()
    {
        // 加载成就数据
        LoadAchievements();
        
        // 注册事件监听
        EventCenter.Instance.AddEventListener<int>(E_GameEvent.E_Enemy_Killed, OnEnemyKilled);
        EventCenter.Instance.AddEventListener<int>(E_GameEvent.E_Coin_Collected, OnCoinCollected);
        EventCenter.Instance.AddEventListener(E_GameEvent.E_Level_Up, OnLevelUp);
        EventCenter.Instance.AddEventListener<float>(E_GameEvent.E_Play_Time, OnPlayTime);
    }
    
    // 加载成就配置
    private void LoadAchievements()
    {
        // 这里可以从JSON或表格加载成就配置
        achievements["kill_10"] = new Achievement
        {
            id = "kill_10",
            title = "初出茅庐",
            description = "击杀10个敌人",
            iconName = "icon_kill",
            targetValue = 10,
            type = AchievementType.KillEnemy,
            isUnlocked = false,
            currentProgress = 0,
            reward = 100
        };
        
        achievements["kill_100"] = new Achievement
        {
            id = "kill_100",
            title = "百人斩",
            description = "击杀100个敌人",
            iconName = "icon_kill",
            targetValue = 100,
            type = AchievementType.KillEnemy,
            isUnlocked = false,
            currentProgress = 0,
            reward = 500
        };
        
        achievements["coin_1000"] = new Achievement
        {
            id = "coin_1000",
            title = "财源滚滚",
            description = "收集1000金币",
            iconName = "icon_coin",
            targetValue = 1000,
            type = AchievementType.CollectCoin,
            isUnlocked = false,
            currentProgress = 0,
            reward = 200
        };
        
        achievements["level_10"] = new Achievement
        {
            id = "level_10",
            title = "进阶强者",
            description = "达到10级",
            iconName = "icon_level",
            targetValue = 10,
            type = AchievementType.LevelUp,
            isUnlocked = false,
            currentProgress = 0,
            reward = 1000
        };
    }
    
    // 更新进度
    public void UpdateProgress(AchievementType type, int value)
    {
        foreach (var achievement in achievements.Values)
        {
            if (achievement.type == type && !achievement.isUnlocked)
            {
                achievement.currentProgress += value;
                achievement.currentProgress = Mathf.Min(achievement.currentProgress, achievement.targetValue);
                
                // 检查是否达成
                if (achievement.currentProgress >= achievement.targetValue)
                {
                    UnlockAchievement(achievement);
                }
            }
        }
    }
    
    // 解锁成就
    private void UnlockAchievement(Achievement achievement)
    {
        achievement.isUnlocked = true;
        
        // 保存数据
        SaveAchievement(achievement);
        
        // 显示弹窗
        ShowAchievementPopup(achievement);
        
        // 发放奖励
        AwardReward(achievement.reward);
        
        // 播放音效
        MusicMgr.Instance.PlaySound("achievement_unlock");
    }
    
    // 显示成就弹窗
    private void ShowAchievementPopup(Achievement achievement)
    {
        // 从对象池获取弹窗
        currentPopup = PoolMgr.Instance.GetObj<AchievementPopup>("AchievementPopup");
        
        // 设置弹窗内容
        currentPopup.Show(achievement.title, achievement.reward);
        
        // 自动隐藏
        TimerMgr.Instance.CreateTimer(
            isRealTime: false,
            allTime: 3000,
            overCallBack: () =>
            {
                if (currentPopup != null)
                {
                    PoolMgr.Instance.PushObj(currentPopup);
                }
            }
        );
    }
    
    // 发放奖励
    private void AwardReward(int gold)
    {
        EventCenter.Instance.EventTrigger<int>(E_GameEvent.E_Coin_Collected, gold);
    }
    
    // 保存成就
    private void SaveAchievement(Achievement achievement)
    {
        PlayerPrefs.SetInt($"Achievement_{achievement.id}", achievement.isUnlocked ? 1 : 0);
        PlayerPrefs.SetInt($"Progress_{achievement.id}", achievement.currentProgress);
    }
    
    // 获取所有成就
    public Achievement[] GetAllAchievements()
    {
        Achievement[] array = new Achievement[achievements.Count];
        achievements.Values.CopyTo(array, 0);
        return array;
    }
    
    // 获取已解锁成就
    public int GetUnlockedCount()
    {
        int count = 0;
        foreach (var achievement in achievements.Values)
        {
            if (achievement.isUnlocked) count++;
        }
        return count;
    }
    
    // 事件回调
    private void OnEnemyKilled(int value)
    {
        UpdateProgress(AchievementType.KillEnemy, 1);
    }
    
    private void OnCoinCollected(int value)
    {
        UpdateProgress(AchievementType.CollectCoin, value);
    }
    
    private void OnLevelUp()
    {
        UpdateProgress(AchievementType.LevelUp, Player.Instance.level);
    }
    
    private void OnPlayTime(float time)
    {
        UpdateProgress(AchievementType.PlayTime, (int)time);
    }
}

// ==================== 成就弹窗 ====================
public class AchievementPopup : MonoBehaviour, IPoolObject
{
    public Text titleText;
    public Text rewardText;
    public Image iconImage;
    public Animation popupAnim;
    
    public void Show(string title, int reward)
    {
        gameObject.SetActive(true);
        titleText.text = $"成就达成！\n{title}";
        rewardText.text = $"+{reward} 金币";
        
        // 播放动画
        popupAnim.Play();
    }
    
    public void ResetInfo()
    {
        gameObject.SetActive(false);
    }
}

// ==================== 成就面板 ====================
public class AchievementPanel : BasePanel
{
    public Transform content;          // ScrollView的内容区域
    public GameObject achievementItemPrefab;  // 成就项预制体
    public Text totalText;             // 总成就数
    
    protected override void Awake()
    {
        base.Awake();
        totalText = GetControl<Text>("TotalText");
    }
    
    public override void ShowMe()
    {
        gameObject.SetActive(true);
        RefreshDisplay();
    }
    
    public override void HideMe()
    {
        gameObject.SetActive(false);
    }
    
    private void RefreshDisplay()
    {
        // 清空现有内容
        foreach (Transform child in content)
        {
            PoolMgr.Instance.PushObj(child.gameObject);
        }
        
        // 显示成就
        Achievement[] achievements = AchievementManager.Instance.GetAllAchievements();
        foreach (var achievement in achievements)
        {
            var item = PoolMgr.Instance.GetObj<AchievementItem>("AchievementItem");
            item.SetData(achievement);
            item.transform.SetParent(content);
            item.transform.localScale = Vector3.one;
        }
        
        // 更新总数
        int unlocked = AchievementManager.Instance.GetUnlockedCount();
        totalText.text = $"成就 {unlocked}/{achievements.Length}";
    }
}

// ==================== 成就项 ====================
public class AchievementItem : MonoBehaviour, IPoolObject
{
    public Image iconImage;
    public Text titleText;
    public Text descText;
    public Slider progressBar;
    public Image completedImage;
    
    public void SetData(Achievement achievement)
    {
        // 加载图标
        Sprite icon = ResMgr.Instance.Load<Sprite>($"Achievements/{achievement.iconName}");
        iconImage.sprite = icon;
        
        titleText.text = achievement.title;
        descText.text = achievement.description;
        
        // 更新进度
        float progress = (float)achievement.currentProgress / achievement.targetValue;
        progressBar.value = progress;
        
        // 已解锁显示
        completedImage.gameObject.SetActive(achievement.isUnlocked);
    }
    
    public void ResetInfo()
    {
        gameObject.SetActive(false);
    }
}
```

---

### 组合3：技能系统

**功能描述**：玩家拥有多个技能，每个技能有冷却时间、消耗、效果。

**涉及模块**：
- `TimerMgr` - 技能冷却
- `EventCenter` - 技能事件
- `UIMgr` - 技能图标和冷却显示
- `MusicMgr` - 技能音效
- `PoolMgr` - 技能特效对象池
- `ResMgr` - 加载技能资源

**实现代码**：

```csharp
// ==================== 技能配置 ====================
[System.Serializable]
public class Skill
{
    public string id;
    public string name;
    public string iconName;
    public float cooldown;         // 冷却时间（秒）
    public int mpCost;             // MP消耗
    public float castRange;        // 施法范围
    public string effectName;      // 特效名称
    public string soundName;       // 音效名称
}

// ==================== 技能管理器 ====================
public class SkillManager : BaseManager<SkillManager>
{
    private SkillManager() { }
    
    private Dictionary<string, Skill> skills = new Dictionary<string, Skill>();
    private Dictionary<string, int> skillCooldowns = new Dictionary<string, int>();  // 毫秒
    private Dictionary<string, int> skillTimers = new Dictionary<string, int>();
    
    public void Initialize()
    {
        LoadSkills();
    }
    
    private void LoadSkills()
    {
        skills["fireball"] = new Skill
        {
            id = "fireball",
            name = "火球术",
            iconName = "skill_fireball",
            cooldown = 3f,
            mpCost = 20,
            castRange = 10f,
            effectName = "FX_Fireball",
            soundName = "skill_fireball"
        };
        
        skills["heal"] = new Skill
        {
            id = "heal",
            name = "治疗术",
            iconName = "skill_heal",
            cooldown = 8f,
            mpCost = 30,
            castRange = 0f,
            effectName = "FX_Heal",
            soundName = "skill_heal"
        };
        
        skills["dash"] = new Skill
        {
            id = "dash",
            name = "冲刺",
            iconName = "skill_dash",
            cooldown = 5f,
            mpCost = 10,
            castRange = 0f,
            effectName = "FX_Dash",
            soundName = "skill_dash"
        };
    }
    
    // 检查技能是否可用
    public bool CanUseSkill(string skillId)
    {
        if (!skills.ContainsKey(skillId)) return false;
        
        Skill skill = skills[skillId];
        
        // 检查MP
        if (Player.Instance.mp < skill.mpCost) return false;
        
        // 检查冷却
        if (skillCooldowns.ContainsKey(skillId) && skillCooldowns[skillId] > 0) return false;
        
        return true;
    }
    
    // 使用技能
    public bool UseSkill(string skillId, Vector3 targetPos = default(Vector3))
    {
        if (!CanUseSkill(skillId)) return false;
        
        Skill skill = skills[skillId];
        
        // 消耗MP
        Player.Instance.ConsumeMP(skill.mpCost);
        
        // 播放音效
        if (!string.IsNullOrEmpty(skill.soundName))
        {
            MusicMgr.Instance.PlaySound(skill.soundName);
        }
        
        // 执行技能效果
        ExecuteSkillEffect(skill, targetPos);
        
        // 开始冷却
        StartCooldown(skillId, skill.cooldown);
        
        // 发送事件
        EventCenter.Instance.EventTrigger(E_GameEvent.E_Skill_Used, skillId);
        
        return true;
    }
    
    // 执行技能效果
    private void ExecuteSkillEffect(Skill skill, Vector3 targetPos)
    {
        switch (skill.id)
        {
            case "fireball":
                ExecuteFireball(skill, targetPos);
                break;
            case "heal":
                ExecuteHeal(skill);
                break;
            case "dash":
                ExecuteDash(skill);
                break;
        }
    }
    
    // 火球术
    private void ExecuteFireball(Skill skill, Vector3 targetPos)
    {
        // 生成火球
        var fireball = PoolMgr.Instance.GetObj<Fireball>("Fireball");
        fireball.transform.position = Player.Instance.transform.position + Vector3.forward;
        fireball.Launch(targetPos, () =>
        {
            PoolMgr.Instance.PushObj(fireball);
        });
        
        // 播放特效
        PlayEffect(skill.effectName, targetPos);
    }
    
    // 治疗术
    private void ExecuteHeal(Skill skill)
    {
        Player.Instance.Heal(50);
        PlayEffect(skill.effectName, Player.Instance.transform.position);
    }
    
    // 冲刺
    private void ExecuteDash(Skill skill)
    {
        Vector3 dashDir = Player.Instance.transform.forward;
        Player.Instance.transform.position += dashDir * 5f;
        PlayEffect(skill.effectName, Player.Instance.transform.position);
    }
    
    // 播放特效
    private void PlayEffect(string effectName, Vector3 position)
    {
        var effect = PoolMgr.Instance.GetObj(effectName);
        effect.transform.position = position;
        effect.SetActive(true);
        
        // 特效结束回收
        float duration = 1f;
        TimerMgr.Instance.CreateTimer(
            isRealTime: false,
            allTime: (int)(duration * 1000),
            overCallBack: () => PoolMgr.Instance.PushObj(effect)
        );
    }
    
    // 开始冷却
    private void StartCooldown(string skillId, float cooldown)
    {
        int cooldownMs = (int)(cooldown * 1000);
        skillCooldowns[skillId] = cooldownMs;
        
        // 创建定时器更新冷却UI
        skillTimers[skillId] = TimerMgr.Instance.CreateTimer(
            isRealTime: false,
            allTime: cooldownMs,
            overCallBack: () =>
            {
                skillCooldowns[skillId] = 0;
            },
            intervalTime: 100,  // 每0.1秒更新一次UI
            callBack: () =>
            {
                // 更新冷却UI
                float remaining = skillCooldowns[skillId] / 1000f;
                EventCenter.Instance.EventTrigger<string, float>(E_GameEvent.E_Skill_Cooldown, skillId, remaining);
            }
        );
    }
    
    // 获取冷却剩余时间
    public float GetCooldownRemaining(string skillId)
    {
        if (skillCooldowns.ContainsKey(skillId))
            return skillCooldowns[skillId] / 1000f;
        return 0;
    }
    
    // 取消技能
    public void CancelSkill(string skillId)
    {
        if (skillTimers.ContainsKey(skillId))
        {
            TimerMgr.Instance.RemoveTimer(skillTimers[skillId]);
            skillTimers.Remove(skillId);
            skillCooldowns[skillId] = 0;
        }
    }
}

// ==================== 技能图标UI ====================
public class SkillIcon : MonoBehaviour
{
    public string skillId;
    public Image iconImage;
    public Image cooldownOverlay;
    public Text cooldownText;
    public Text mpCostText;
    public Button button;
    
    private Skill skill;
    
    private void Start()
    {
        skill = SkillManager.Instance.skills[skillId];
        
        // 加载图标
        Sprite icon = ResMgr.Instance.Load<Sprite>($"Skills/{skill.iconName}");
        iconImage.sprite = icon;
        
        // 显示MP消耗
        mpCostText.text = skill.mpCost.ToString();
        
        // 绑定点击事件
        button.onClick.AddListener(OnClick);
        
        // 监听冷却事件
        EventCenter.Instance.AddEventListener<string, float>(E_GameEvent.E_Skill_Cooldown, OnCooldownUpdate);
        
        // 注册技能
        EventCenter.Instance.AddEventListener(E_GameEvent.E_Skill_Used, OnSkillUsed);
    }
    
    private void OnClick()
    {
        if (SkillManager.Instance.CanUseSkill(skillId))
        {
            Vector3 targetPos = Player.Instance.transform.position + Player.Instance.transform.forward * 5f;
            SkillManager.Instance.UseSkill(skillId, targetPos);
        }
        else
        {
            // 播放无法使用的音效
            MusicMgr.Instance.PlaySound("skill_failed");
        }
    }
    
    private void OnCooldownUpdate(string id, float remaining)
    {
        if (id != skillId) return;
        
        // 更新冷却显示
        cooldownOverlay.fillAmount = remaining / skill.cooldown;
        
        if (remaining > 0)
        {
            cooldownText.text = remaining.ToString("F1");
            cooldownText.gameObject.SetActive(true);
            button.interactable = false;
        }
        else
        {
            cooldownText.gameObject.SetActive(false);
            cooldownOverlay.fillAmount = 0;
            button.interactable = true;
        }
    }
    
    private void OnSkillUsed(string id)
    {
        if (id == skillId)
        {
            button.interactable = false;
        }
    }
    
    private void OnDestroy()
    {
        EventCenter.Instance.RemoveEventListener<string, float>(E_GameEvent.E_Skill_Cooldown, OnCooldownUpdate);
        EventCenter.Instance.RemoveEventListener(E_GameEvent.E_Skill_Used, OnSkillUsed);
    }
}

// ==================== 技能栏面板 ====================
public class SkillBarPanel : BasePanel
{
    public SkillIcon[] skillIcons;  // 拖入4个技能图标
    
    protected override void Awake()
    {
        base.Awake();
        
        // 初始化技能图标
        for (int i = 0; i < skillIcons.Length; i++)
        {
            // 设置技能ID
        }
    }
    
    public override void ShowMe()
    {
        gameObject.SetActive(true);
    }
    
    public override void HideMe()
    {
        gameObject.SetActive(false);
    }
}

// ==================== 玩家技能相关 ====================
public class Player : MonoBehaviour
{
    public int level = 1;
    public int mp = 100;
    public int maxMp = 100;
    
    public void ConsumeMP(int amount)
    {
        mp -= amount;
        mp = Mathf.Max(0, mp);
        
        // 更新MP UI
        EventCenter.Instance.EventTrigger(E_GameEvent.E_MP_Changed);
    }
    
    public void Heal(int amount)
    {
        mp += amount;
        mp = Mathf.Min(maxMp, mp);
        EventCenter.Instance.EventTrigger(E_GameEvent.E_MP_Changed);
    }
}
```

---

### 组合4：存档与读档

**功能描述**：保存和加载游戏进度，包括金币、等级、道具等。

**涉及模块**：
- `BaseManager<T>` - 存档管理器
- `EventCenter` - 存档事件
- `PoolMgr` - 存档界面对象池
- `UIMgr` - 存档UI
- `EncryptionUtil` - 数据加密

**实现代码**：

```csharp
// ==================== 存档数据 ====================
[System.Serializable]
public class SaveData
{
    public string saveName;
    public long timestamp;
    public int playerLevel;
    public int playerExp;
    public int gold;
    public int diamond;
    public int stage;
    public List<ItemData> items;
    public List<SkillData> skills;
    public Dictionary<string, bool> achievements;
    public int playTime;  // 游玩时间（秒）
}

// 道具数据
[System.Serializable]
public class ItemData
{
    public string itemId;
    public int count;
}

// 技能数据
[System.Serializable]
public class SkillData
{
    public string skillId;
    public int level;
}

// ==================== 存档管理器 ====================
public class SaveManager : BaseManager<SaveManager>
{
    private SaveManager() { }
    
    private const string SAVE_KEY_PREFIX = "SaveData_";
    private const string SETTINGS_KEY = "GameSettings";
    
    // 当前存档
    private SaveData currentSave;
    
    // 创建新存档
    public SaveData CreateNewSave(string name)
    {
        return new SaveData
        {
            saveName = name,
            timestamp = GetTimestamp(),
            playerLevel = 1,
            playerExp = 0,
            gold = 1000,
            diamond = 100,
            stage = 1,
            items = new List<ItemData>(),
            skills = new List<SkillData>(),
            achievements = new Dictionary<string, bool>(),
            playTime = 0
        };
    }
    
    // 保存游戏
    public void SaveGame(string slotName)
    {
        // 更新当前存档数据
        currentSave.timestamp = GetTimestamp();
        
        // 加密存档数据
        string json = JsonUtility.ToJson(currentSave);
        int key = EncryptionUtil.GetRandomKey();
        int encryptedGold = EncryptionUtil.LockValue(currentSave.gold, key);
        int encryptedDiamond = EncryptionUtil.LockValue(currentSave.diamond, key);
        
        // 存储
        PlayerPrefs.SetString($"{SAVE_KEY_PREFIX}{slotName}_json", json);
        PlayerPrefs.SetInt($"{SAVE_KEY_PREFIX}{slotName}_key", key);
        PlayerPrefs.SetInt($"{SAVE_KEY_PREFIX}{slotName}_gold", encryptedGold);
        PlayerPrefs.SetInt($"{SAVE_KEY_PREFIX}{slotName}_diamond", encryptedDiamond);
        PlayerPrefs.Save();
        
        // 发送事件
        EventCenter.Instance.EventTrigger(E_GameEvent.E_Game_Saved);
        Debug.Log($"存档 {slotName} 保存成功！");
    }
    
    // 加载存档
    public bool LoadGame(string slotName, out SaveData saveData)
    {
        saveData = null;
        
        string json = PlayerPrefs.GetString($"{SAVE_KEY_PREFIX}{slotName}_json", "");
        if (string.IsNullOrEmpty(json))
        {
            Debug.LogWarning($"存档 {slotName} 不存在！");
            return false;
        }
        
        try
        {
            // 解密
            int key = PlayerPrefs.GetInt($"{SAVE_KEY_PREFIX}{slotName}_key", 0);
            int savedGold = PlayerPrefs.GetInt($"{SAVE_KEY_PREFIX}{slotName}_gold", 0);
            int savedDiamond = PlayerPrefs.GetInt($"{SAVE_KEY_PREFIX}{slotName}_diamond", 0);
            
            saveData = JsonUtility.FromJson<SaveData>(json);
            
            // 恢复加密数据
            saveData.gold = EncryptionUtil.UnLoackValue(savedGold, key);
            saveData.diamond = EncryptionUtil.UnLoackValue(savedDiamond, key);
            
            currentSave = saveData;
            
            // 应用存档数据到游戏
            ApplySaveData(saveData);
            
            Debug.Log($"存档 {slotName} 加载成功！");
            return true;
        }
        catch (System.Exception e)
        {
            Debug.LogError($"存档加载失败：{e.Message}");
            return false;
        }
    }
    
    // 应用存档数据
    private void ApplySaveData(SaveData saveData)
    {
        // 应用玩家数据
        Player.Instance.level = saveData.playerLevel;
        Player.Instance.exp = saveData.playerExp;
        Player.Instance.gold = saveData.gold;
        
        // 应用道具
        InventoryManager.Instance.ClearItems();
        foreach (var item in saveData.items)
        {
            InventoryManager.Instance.AddItem(item.itemId, item.count);
        }
        
        // 应用技能
        foreach (var skill in saveData.skills)
        {
            SkillManager.Instance.UnlockSkill(skill.skillId);
        }
        
        // 发送事件
        EventCenter.Instance.EventTrigger(E_GameEvent.E_Game_Loaded);
    }
    
    // 获取所有存档槽位
    public List<string> GetAllSaveSlots()
    {
        List<string> slots = new List<string>();
        for (int i = 1; i <= 3; i++)
        {
            string slotName = $"Slot{i}";
            if (PlayerPrefs.HasKey($"{SAVE_KEY_PREFIX}{slotName}_json"))
            {
                slots.Add(slotName);
            }
        }
        return slots;
    }
    
    // 获取存档信息（用于显示存档列表）
    public SaveInfo GetSaveInfo(string slotName)
    {
        string json = PlayerPrefs.GetString($"{SAVE_KEY_PREFIX}{slotName}_json", "");
        if (string.IsNullOrEmpty(json))
        {
            return null;
        }
        
        var saveData = JsonUtility.FromJson<SaveData>(json);
        return new SaveInfo
        {
            slotName = slotName,
            playerLevel = saveData.playerLevel,
            gold = saveData.gold,
            timestamp = saveData.timestamp,
            playTime = saveData.playTime
        };
    }
    
    // 删除存档
    public void DeleteSave(string slotName)
    {
        PlayerPrefs.DeleteKey($"{SAVE_KEY_PREFIX}{slotName}_json");
        PlayerPrefs.DeleteKey($"{SAVE_KEY_PREFIX}{slotName}_key");
        PlayerPrefs.DeleteKey($"{SAVE_KEY_PREFIX}{slotName}_gold");
        PlayerPrefs.DeleteKey($"{SAVE_KEY_PREFIX}{slotName}_diamond");
        PlayerPrefs.Save();
        
        Debug.Log($"存档 {slotName} 已删除！");
    }
    
    // 自动保存
    private int autoSaveTimer;
    
    public void StartAutoSave(int intervalSeconds = 60)
    {
        autoSaveTimer = TimerMgr.Instance.CreateTimer(
            isRealTime: true,
            allTime: intervalSeconds * 1000,
            overCallBack: () =>
            {
                SaveGame("AutoSave");
                // 重新开始计时
                StartAutoSave(intervalSeconds);
            },
            intervalTime: intervalSeconds * 1000
        );
    }
    
    // 停止自动保存
    public void StopAutoSave()
    {
        if (autoSaveTimer > 0)
        {
            TimerMgr.Instance.RemoveTimer(autoSaveTimer);
        }
    }
    
    private long GetTimestamp()
    {
        return System.DateTimeOffset.UtcNow.ToUnixTimeSeconds();
    }
}

// ==================== 存档信息 ====================
public class SaveInfo
{
    public string slotName;
    public int playerLevel;
    public int gold;
    public long timestamp;
    public int playTime;
    
    public string GetFormattedTime()
    {
        var dateTime = System.DateTimeOffset.FromUnixTimeSeconds(timestamp).LocalDateTime;
        return dateTime.ToString("yyyy-MM-dd HH:mm");
    }
    
    public string GetFormattedPlayTime()
    {
        int hours = playTime / 3600;
        int minutes = (playTime % 3600) / 60;
        return $"{hours}小时{minutes}分钟";
    }
}

// ==================== 存档面板 ====================
public class SavePanel : BasePanel
{
    public Transform saveSlotContainer;
    public GameObject saveSlotPrefab;
    
    protected override void Awake()
    {
        base.Awake();
    }
    
    public override void ShowMe()
    {
        gameObject.SetActive(true);
        RefreshSaveSlots();
    }
    
    public override void HideMe()
    {
        gameObject.SetActive(false);
    }
    
    private void RefreshSaveSlots()
    {
        // 清空现有槽位
        foreach (Transform child in saveSlotContainer)
        {
            PoolMgr.Instance.PushObj(child.gameObject);
        }
        
        // 显示存档槽位
        List<string> slots = SaveManager.Instance.GetAllSaveSlots();
        foreach (string slot in slots)
        {
            var slotObj = PoolMgr.Instance.GetObj<SaveSlot>("SaveSlot");
            slotObj.SetData(slot);
            slotObj.transform.SetParent(saveSlotContainer);
            slotObj.transform.localScale = Vector3.one;
        }
    }
    
    // 快速存档
    public void QuickSave()
    {
        SaveManager.Instance.SaveGame("QuickSave");
        ShowToast("游戏已保存");
    }
    
    // 快速读档
    public void QuickLoad()
    {
        if (SaveManager.Instance.LoadGame("QuickSave", out var saveData))
        {
            ShowToast("存档已加载");
        }
        else
        {
            ShowToast("没有存档");
        }
    }
}

// ==================== 存档槽位 ====================
public class SaveSlot : MonoBehaviour, IPoolObject
{
    public Text levelText;
    public Text goldText;
    public Text timeText;
    public Button loadButton;
    public Button saveButton;
    public Button deleteButton;
    
    private string slotName;
    
    public void SetData(string slotName)
    {
        this.slotName = slotName;
        
        var saveInfo = SaveManager.Instance.GetSaveInfo(slotName);
        if (saveInfo != null)
        {
            levelText.text = $"等级：{saveInfo.playerLevel}";
            goldText.text = $"金币：{saveInfo.gold}";
            timeText.text = $"{saveInfo.GetFormattedTime()} | {saveInfo.GetFormattedPlayTime()}";
            loadButton.gameObject.SetActive(true);
        }
        else
        {
            levelText.text = "空存档位";
            goldText.text = "";
            timeText.text = "";
            loadButton.gameObject.SetActive(false);
        }
    }
    
    private void Start()
    {
        loadButton.onClick.AddListener(OnLoad);
        saveButton.onClick.AddListener(OnSave);
        deleteButton.onClick.AddListener(OnDelete);
    }
    
    private void OnLoad()
    {
        if (SaveManager.Instance.LoadGame(slotName, out var saveData))
        {
            // 隐藏存档面板
            UIMgr.Instance.HidePanel<SavePanel>();
        }
    }
    
    private void OnSave()
    {
        SaveManager.Instance.SaveGame(slotName);
        RefreshDisplay();
    }
    
    private void OnDelete()
    {
        ConfirmDialog.Show("确定要删除这个存档吗？", () =>
        {
            SaveManager.Instance.DeleteSave(slotName);
            RefreshDisplay();
        });
    }
    
    private void RefreshDisplay()
    {
        SetData(slotName);
    }
    
    public void ResetInfo()
    {
        gameObject.SetActive(false);
    }
}
```

---

### 组合5：商城系统

**功能描述**：玩家可以购买道具、皮肤、技能等，有购买记录和推荐商品。

**涉及模块**：
- `BaseManager<T>` - 商城管理器
- `UIMgr` - 商城UI
- `ResMgr` - 加载商品图标
- `EventCenter` - 购买事件
- `PoolMgr` - 商城面板对象池
- `MusicMgr` - 购买音效

**实现代码**：

```csharp
// ==================== 商品配置 ====================
[System.Serializable]
public class ShopItem
{
    public string id;
    public string name;
    public string description;
    public ShopItemType type;
    public int price;
    public string iconName;
    public bool isLimited;          // 是否限时
    public bool isHot;              // 是否热门
    public int discount;            // 折扣（100=原价，80=8折）
    public int stock;               // 库存（-1=无限）
    public string itemId;           // 关联的道具ID
    public int count;               // 购买数量
}

// 商品类型
public enum ShopItemType
{
    Item,       // 消耗品
    Weapon,     // 武器
    Skin,       // 皮肤
    Skill,      // 技能
    Package,    // 礼包
}

// ==================== 商城管理器 ====================
public class ShopManager : BaseManager<ShopManager>
{
    private ShopManager() { }
    
    private Dictionary<string, ShopItem> items = new Dictionary<string, ShopItem>();
    private List<string> purchasedItems = new List<string>();  // 已购买道具ID列表
    
    public void Initialize()
    {
        LoadShopItems();
        LoadPurchaseHistory();
    }
    
    private void LoadShopItems()
    {
        // 消耗品
        items["hp_potion"] = new ShopItem
        {
            id = "hp_potion",
            name = "生命药水",
            description = "恢复100点生命值",
            type = ShopItemType.Item,
            price = 100,
            iconName = "icon_hp_potion",
            isLimited = false,
            isHot = false,
            discount = 100,
            stock = -1,
            itemId = "hp_potion",
            count = 1
        };
        
        items["mp_potion"] = new ShopItem
        {
            id = "mp_potion",
            name = "魔法药水",
            description = "恢复50点魔法值",
            type = ShopItemType.Item,
            price = 80,
            iconName = "icon_mp_potion",
            isLimited = false,
            isHot = true,
            discount = 100,
            stock = -1,
            itemId = "mp_potion",
            count = 1
        };
        
        // 礼包
        items["starter_pack"] = new ShopItem
        {
            id = "starter_pack",
            name = "新手礼包",
            description = "包含1000金币和10瓶药水",
            type = ShopItemType.Package,
            price = 6,  // 6元
            iconName = "icon_starter_pack",
            isLimited = true,
            isHot = true,
            discount = 100,
            stock = 1,
            itemId = "starter_pack",
            count = 1
        };
        
        // 皮肤
        items["skin_ninja"] = new ShopItem
        {
            id = "skin_ninja",
            name = "忍者皮肤",
            description = "炫酷的忍者外观",
            type = ShopItemType.Skin,
            price = 500,
            iconName = "icon_skin_ninja",
            isLimited = false,
            isHot = false,
            discount = 80,
            stock = -1,
            itemId = "skin_ninja",
            count = 1
        };
    }
    
    // 购买商品
    public bool BuyItem(string itemId, int quantity = 1)
    {
        if (!items.ContainsKey(itemId))
        {
            ShowToast("商品不存在！");
            return false;
        }
        
        ShopItem item = items[itemId];
        
        // 检查库存
        if (item.stock != -1 && item.stock < quantity)
        {
            ShowToast("库存不足！");
            return false;
        }
        
        // 计算价格
        int totalPrice = item.price * item.discount / 100 * quantity;
        
        // 检查金币
        if (Player.Instance.gold < totalPrice)
        {
            ShowToast("金币不足！");
            return false;
        }
        
        // 扣除金币
        Player.Instance.ConsumeGold(totalPrice);
        
        // 扣除库存
        if (item.stock != -1)
        {
            item.stock -= quantity;
        }
        
        // 发放道具
        for (int i = 0; i < quantity; i++)
        {
            InventoryManager.Instance.AddItem(item.itemId, item.count);
            
            // 如果是永久道具，记录已购买
            if (item.type == ShopItemType.Skin && !purchasedItems.Contains(item.itemId))
            {
                purchasedItems.Add(item.itemId);
            }
        }
        
        // 购买记录
        SavePurchaseHistory(itemId, quantity);
        
        // 播放音效
        MusicMgr.Instance.PlaySound("purchase_success");
        
        // 发送事件
        EventCenter.Instance.EventTrigger<string>(E_GameEvent.E_Item_Purchased, itemId);
        
        ShowToast($"购买成功！获得 {item.name}x{quantity}");
        
        return true;
    }
    
    // 检查是否已购买（用于永久道具）
    public bool IsItemPurchased(string itemId)
    {
        return purchasedItems.Contains(itemId);
    }
    
    // 获取所有商品
    public ShopItem[] GetAllItems()
    {
        ShopItem[] array = new ShopItem[items.Count];
        items.Values.CopyTo(array, 0);
        return array;
    }
    
    // 获取热门商品
    public ShopItem[] GetHotItems()
    {
        List<ShopItem> hotItems = new List<ShopItem>();
        foreach (var item in items.Values)
        {
            if (item.isHot) hotItems.Add(item);
        }
        return hotItems.ToArray();
    }
    
    // 获取限时商品
    public ShopItem[] GetLimitedItems()
    {
        List<ShopItem> limitedItems = new List<ShopItem>();
        foreach (var item in items.Values)
        {
            if (item.isLimited && item.stock > 0) limitedItems.Add(item);
        }
        return limitedItems.ToArray();
    }
    
    // 购买历史
    private void LoadPurchaseHistory()
    {
        string history = PlayerPrefs.GetString("PurchaseHistory", "");
        if (!string.IsNullOrEmpty(history))
        {
            purchasedItems = new List<string>(history.Split(','));
        }
    }
    
    private void SavePurchaseHistory(string itemId, int quantity)
    {
        if (!purchasedItems.Contains(itemId))
        {
            purchasedItems.Add(itemId);
            string history = string.Join(",", purchasedItems.ToArray());
            PlayerPrefs.SetString("PurchaseHistory", history);
        }
    }
    
    private void ShowToast(string message)
    {
        EventCenter.Instance.EventTrigger<string>(E_GameEvent.E_Show_Toast, message);
    }
}

// ==================== 商城面板 ====================
public class ShopPanel : BasePanel
{
    public Transform itemContainer;
    public GameObject itemPrefab;
    public TabButton[] tabs;
    
    private ShopItemType currentTab = ShopItemType.Item;
    
    protected override void Awake()
    {
        base.Awake();
        
        // 初始化标签页
        for (int i = 0; i < tabs.Length; i++)
        {
            int index = i;
            tabs[i].onClick.AddListener(() => OnTabClick((ShopItemType)index));
        }
    }
    
    public override void ShowMe()
    {
        gameObject.SetActive(true);
        RefreshItems();
    }
    
    public override void HideMe()
    {
        gameObject.SetActive(false);
    }
    
    private void OnTabClick(ShopItemType type)
    {
        currentTab = type;
        RefreshItems();
    }
    
    private void RefreshItems()
    {
        // 清空现有商品
        foreach (Transform child in itemContainer)
        {
            PoolMgr.Instance.PushObj(child.gameObject);
        }
        
        // 显示当前分类的商品
        ShopItem[] allItems = ShopManager.Instance.GetAllItems();
        foreach (var item in allItems)
        {
            if (item.type == currentTab)
            {
                var itemObj = PoolMgr.Instance.GetObj<ShopItemCell>("ShopItemCell");
                itemObj.SetData(item);
                itemObj.transform.SetParent(itemContainer);
                itemObj.transform.localScale = Vector3.one;
            }
        }
    }
}

// ==================== 商品单元格 ====================
public class ShopItemCell : MonoBehaviour, IPoolObject
{
    public Image iconImage;
    public Text nameText;
    public Text descText;
    public Text priceText;
    public Image discountImage;
    public Text discountText;
    public Button buyButton;
    
    private ShopItem item;
    
    public void SetData(ShopItem item)
    {
        this.item = item;
        
        // 加载图标
        Sprite icon = ResMgr.Instance.Load<Sprite>($"Shop/{item.iconName}");
        iconImage.sprite = icon;
        
        nameText.text = item.name;
        descText.text = item.description;
        
        // 价格
        int finalPrice = item.price * item.discount / 100;
        if (item.discount < 100)
        {
            priceText.text = $"<s>{item.price}</s> {finalPrice}";
            discountImage.gameObject.SetActive(true);
            discountText.text = $"{item.discount/10:F1}折";
        }
        else
        {
            priceText.text = item.price.ToString();
            discountImage.gameObject.SetActive(false);
        }
        
        // 库存
        if (item.stock == 0)
        {
            buyButton.interactable = false;
            buyButton.GetComponentInChildren<Text>().text = "已售罄";
        }
        
        // 绑定购买事件
        buyButton.onClick.RemoveAllListeners();
        buyButton.onClick.AddListener(OnBuy);
    }
    
    private void OnBuy()
    {
        ShopManager.Instance.BuyItem(item.id);
    }
    
    public void ResetInfo()
    {
        gameObject.SetActive(false);
    }
}

// ==================== 标签页按钮 ====================
public class TabButton : MonoBehaviour
{
    public Button button;
    public Image selectedImage;
    
    public void SetSelected(bool selected)
    {
        selectedImage.gameObject.SetActive(selected);
    }
}
```

---

### 组合6：任务系统

**功能描述**：玩家可以接受任务、完成任务、获得奖励。

**涉及模块**：
- `BaseManager<T>` - 任务管理器
- `EventCenter` - 任务事件
- `UIMgr` - 任务UI
- `ResMgr` - 任务资源
- `TimerMgr` - 任务倒计时

**实现代码**：

```csharp
// ==================== 任务配置 ====================
[System.Serializable]
public class Quest
{
    public string id;
    public string title;
    public string description;
    public QuestType type;
    public QuestTarget target;
    public int requireCount;
    public QuestReward reward;
    public QuestState state;
    public int currentProgress;
    public int timeLimit;  // 时间限制（秒），-1=无限制
    public int timeRemaining;  // 剩余时间
}

// 任务类型
public enum QuestType
{
    KillEnemy,      // 击杀敌人
    CollectItem,    // 收集物品
    ReachLevel,     // 达到等级
    UseSkill,       // 使用技能
    TalkNPC,        // 与NPC对话
    ClearStage,     // 通关关卡
}

// 任务目标
[System.Serializable]
public class QuestTarget
{
    public int targetId;     // 目标ID（如敌人ID、物品ID）
    public string targetName;
}

// 任务奖励
[System.Serializable]
public class QuestReward
{
    public int exp;
    public int gold;
    public string[] itemIds;
    public int[] itemCounts;
}

// 任务状态
public enum QuestState
{
    NotStarted,     // 未开始
    InProgress,     // 进行中
    Completed,      // 可领取
    Finished,       // 已完成
}

// ==================== 任务管理器 ====================
public class QuestManager : BaseManager<QuestManager>
{
    private QuestManager() { }
    
    private Dictionary<string, Quest> allQuests = new Dictionary<string, Quest>();
    private Dictionary<string, Quest> activeQuests = new Dictionary<string, Quest>();
    private List<string> completedQuests = new List<string>();
    private Dictionary<string, int> questTimers = new Dictionary<string, int>();
    
    public void Initialize()
    {
        LoadQuests();
        RegisterEventListeners();
    }
    
    private void LoadQuests()
    {
        // 主线任务
        allQuests["quest_001"] = new Quest
        {
            id = "quest_001",
            title = "初入江湖",
            description = "击败10个敌人来证明你的实力",
            type = QuestType.KillEnemy,
            target = new QuestTarget { targetId = 0, targetName = "敌人" },
            requireCount = 10,
            reward = new QuestReward { exp = 100, gold = 50 },
            state = QuestState.NotStarted,
            currentProgress = 0,
            timeLimit = -1
        };
        
        allQuests["quest_002"] = new Quest
        {
            id = "quest_002",
            title = "收集之旅",
            description = "收集50个金币",
            type = QuestType.CollectItem,
            target = new QuestTarget { targetId = 1, targetName = "金币" },
            requireCount = 50,
            reward = new QuestReward { exp = 150, gold = 100 },
            state = QuestState.NotStarted,
            currentProgress = 0,
            timeLimit = 300  // 5分钟内完成
        };
        
        // 每日任务
        allQuests["daily_001"] = new Quest
        {
            id = "daily_001",
            title = "每日击杀",
            description = "今天击杀20个敌人",
            type = QuestType.KillEnemy,
            target = new QuestTarget { targetId = 0, targetName = "敌人" },
            requireCount = 20,
            reward = new QuestReward { exp = 200, gold = 80 },
            state = QuestState.NotStarted,
            currentProgress = 0,
            timeLimit = 86400  // 24小时
        };
    }
    
    private void RegisterEventListeners()
    {
        EventCenter.Instance.AddEventListener<int>(E_GameEvent.E_Enemy_Killed, OnEnemyKilled);
        EventCenter.Instance.AddEventListener<int>(E_GameEvent.E_Coin_Collected, OnCoinCollected);
    }
    
    // 接受任务
    public void AcceptQuest(string questId)
    {
        if (!allQuests.ContainsKey(questId)) return;
        
        Quest quest = allQuests[questId];
        if (quest.state != QuestState.NotStarted) return;
        
        quest.state = QuestState.InProgress;
        quest.currentProgress = 0;
        activeQuests[questId] = quest;
        
        // 如果有时限，开始倒计时
        if (quest.timeLimit > 0)
        {
            StartQuestTimer(questId);
        }
        
        // 发送事件
        EventCenter.Instance.EventTrigger<string>(E_GameEvent.E_Quest_Accepted, questId);
        
        ShowQuestAcceptEffect(quest);
    }
    
    // 更新任务进度
    public void UpdateQuestProgress(QuestType type, int targetId, int count = 1)
    {
        foreach (var quest in activeQuests.Values)
        {
            if (quest.type == type && quest.target.targetId == targetId && quest.state == QuestState.InProgress)
            {
                quest.currentProgress += count;
                
                // 检查是否完成
                if (quest.currentProgress >= quest.requireCount)
                {
                    CompleteQuest(quest.id);
                }
                else
                {
                    // 发送进度更新事件
                    EventCenter.Instance.EventTrigger<string, int>(E_GameEvent.E_Quest_Progress, quest.id, quest.currentProgress);
                }
            }
        }
    }
    
    // 完成任务
    private void CompleteQuest(string questId)
    {
        if (!activeQuests.ContainsKey(questId)) return;
        
        Quest quest = activeQuests[questId];
        quest.state = QuestState.Completed;
        
        // 停止计时器
        StopQuestTimer(questId);
        
        // 发送事件
        EventCenter.Instance.EventTrigger<string>(E_GameEvent.E_Quest_Completed, questId);
    }
    
    // 领取奖励
    public void ClaimReward(string questId)
    {
        if (!activeQuests.ContainsKey(questId)) return;
        
        Quest quest = activeQuests[questId];
        if (quest.state != QuestState.Completed) return;
        
        // 发放奖励
        Player.Instance.AddExp(quest.reward.exp);
        Player.Instance.AddGold(quest.reward.gold);
        
        for (int i = 0; i < quest.reward.itemIds.Length; i++)
        {
            InventoryManager.Instance.AddItem(quest.reward.itemIds[i], quest.reward.itemCounts[i]);
        }
        
        quest.state = QuestState.Finished;
        activeQuests.Remove(questId);
        completedQuests.Add(questId);
        
        // 发送事件
        EventCenter.Instance.EventTrigger<string>(E_GameEvent.E_Quest_Rewarded, questId);
        
        ShowQuestRewardEffect(quest);
    }
    
    // 放弃任务
    public void AbandonQuest(string questId)
    {
        if (!activeQuests.ContainsKey(questId)) return;
        
        Quest quest = activeQuests[questId];
        quest.state = QuestState.NotStarted;
        quest.currentProgress = 0;
        
        StopQuestTimer(questId);
        activeQuests.Remove(questId);
    }
    
    // 任务倒计时
    private void StartQuestTimer(string questId)
    {
        Quest quest = activeQuests[questId];
        quest.timeRemaining = quest.timeLimit;
        
        questTimers[questId] = TimerMgr.Instance.CreateTimer(
            isRealTime: true,
            allTime: quest.timeLimit * 1000,
            overCallBack: () =>
            {
                // 时间到，任务失败
                quest.state = QuestState.NotStarted;
                activeQuests.Remove(questId);
                questTimers.Remove(questId);
                
                ShowToast("任务时间到，任务失败！");
            },
            intervalTime: 1000,
            callBack: () =>
            {
                quest.timeRemaining--;
                EventCenter.Instance.EventTrigger<string, int>(E_GameEvent.E_Quest_TimeUpdate, questId, quest.timeRemaining);
            }
        );
    }
    
    private void StopQuestTimer(string questId)
    {
        if (questTimers.ContainsKey(questId))
        {
            TimerMgr.Instance.RemoveTimer(questTimers[questId]);
            questTimers.Remove(questId);
        }
    }
    
    // 事件回调
    private void OnEnemyKilled(int value)
    {
        UpdateQuestProgress(QuestType.KillEnemy, 0, 1);
    }
    
    private void OnCoinCollected(int value)
    {
        UpdateQuestProgress(QuestType.CollectItem, 1, value);
    }
    
    // 获取任务列表
    public Quest[] GetActiveQuests()
    {
        Quest[] array = new Quest[activeQuests.Count];
        activeQuests.Values.CopyTo(array, 0);
        return array;
    }
    
    public Quest[] GetAvailableQuests()
    {
        List<Quest> available = new List<Quest>();
        foreach (var quest in allQuests.Values)
        {
            if (quest.state == QuestState.NotStarted)
            {
                available.Add(quest);
            }
        }
        return available.ToArray();
    }
    
    private void ShowQuestAcceptEffect(Quest quest)
    {
        MusicMgr.Instance.PlaySound("quest_accept");
        // 显示任务接受特效
    }
    
    private void ShowQuestRewardEffect(Quest quest)
    {
        MusicMgr.Instance.PlaySound("quest_complete");
        // 显示奖励特效
    }
    
    private void ShowToast(string message)
    {
        EventCenter.Instance.EventTrigger<string>(E_GameEvent.E_Show_Toast, message);
    }
}

// ==================== 任务面板 ====================
public class QuestPanel : BasePanel
{
    public Transform activeQuestContainer;
    public Transform availableQuestContainer;
    public GameObject questItemPrefab;
    
    protected override void Awake()
    {
        base.Awake();
    }
    
    public override void ShowMe()
    {
        gameObject.SetActive(true);
        RefreshQuests();
    }
    
    public override void HideMe()
    {
        gameObject.SetActive(false);
    }
    
    private void RefreshQuests()
    {
        // 清空容器
        foreach (Transform child in activeQuestContainer) PoolMgr.Instance.PushObj(child.gameObject);
        foreach (Transform child in availableQuestContainer) PoolMgr.Instance.PushObj(child.gameObject);
        
        // 显示进行中任务
        Quest[] activeQuests = QuestManager.Instance.GetActiveQuests();
        foreach (var quest in activeQuests)
        {
            var item = PoolMgr.Instance.GetObj<QuestItem>("QuestItem");
            item.SetData(quest, QuestState.InProgress);
            item.transform.SetParent(activeQuestContainer);
            item.transform.localScale = Vector3.one;
        }
        
        // 显示可接受任务
        Quest[] availableQuests = QuestManager.Instance.GetAvailableQuests();
        foreach (var quest in availableQuests)
        {
            var item = PoolMgr.Instance.GetObj<QuestItem>("QuestItem");
            item.SetData(quest, QuestState.NotStarted);
            item.transform.SetParent(availableQuestContainer);
            item.transform.localScale = Vector3.one;
        }
    }
}

// ==================== 任务项 ====================
public class QuestItem : MonoBehaviour, IPoolObject
{
    public Text titleText;
    public Text descText;
    public Slider progressBar;
    public Text progressText;
    public Text timeText;
    public Button actionButton;
    
    private Quest quest;
    
    public void SetData(Quest quest, QuestState displayState)
    {
        this.quest = quest;
        
        titleText.text = quest.title;
        descText.text = quest.description;
        
        if (quest.state == QuestState.InProgress)
        {
            float progress = (float)quest.currentProgress / quest.requireCount;
            progressBar.value = progress;
            progressText.text = $"{quest.currentProgress}/{quest.requireCount}";
            
            if (quest.timeLimit > 0)
            {
                int minutes = quest.timeRemaining / 60;
                int seconds = quest.timeRemaining % 60;
                timeText.text = $"剩余 {minutes}:{seconds:D2}";
                timeText.gameObject.SetActive(true);
            }
            else
            {
                timeText.gameObject.SetActive(false);
            }
            
            actionButton.GetComponentInChildren<Text>().text = "进行中";
            actionButton.interactable = false;
        }
        else if (quest.state == QuestState.Completed)
        {
            progressBar.value = 1;
            progressText.text = "完成";
            timeText.gameObject.SetActive(false);
            
            actionButton.GetComponentInChildren<Text>().text = "领取奖励";
            actionButton.interactable = true;
            actionButton.onClick.RemoveAllListeners();
            actionButton.onClick.AddListener(OnClaimReward);
        }
        else
        {
            progressBar.value = 0;
            progressText.text = "0/0";
            timeText.gameObject.SetActive(false);
            
            actionButton.GetComponentInChildren<Text>().text = "接受任务";
            actionButton.interactable = true;
            actionButton.onClick.RemoveAllListeners();
            actionButton.onClick.AddListener(OnAcceptQuest);
        }
    }
    
    private void OnAcceptQuest()
    {
        QuestManager.Instance.AcceptQuest(quest.id);
        RefreshDisplay();
    }
    
    private void OnClaimReward()
    {
        QuestManager.Instance.ClaimReward(quest.id);
    }
    
    private void RefreshDisplay()
    {
        // 刷新面板
        UIMgr.Instance.GetPanel<QuestPanel>((panel) => panel.RefreshQuests());
    }
    
    public void ResetInfo()
    {
        gameObject.SetActive(false);
    }
}
```

---

### 更多模块组合

由于篇幅限制，这里简要列出更多常用的模块组合：

---

### 组合7：新手引导系统

**所需模块**：`EventCenter` + `UIMgr` + `PoolMgr` + `TimerMgr`

**功能**：指引玩家熟悉游戏，包含步骤引导、高亮显示、跳过功能

```csharp
// 核心思路：
// 1. 定义引导步骤
// 2. 按步骤显示引导UI
// 3. 监听玩家行为判断是否完成引导
// 4. 完成引导后记录状态
```

---

### 组合8：公告与活动系统

**所需模块**：`UWQResMgr` + `UIMgr` + `EventCenter` + `ResMgr`

**功能**：从服务器获取公告、显示活动奖励、限时活动倒计时

```csharp
// 核心思路：
// 1. 启动时从服务器获取公告数据
// 2. 在公告面板显示
// 3. 活动有截止时间，用TimerMgr倒计时
// 4. 活动开始/结束发送事件
```

---

### 组合9：每日奖励系统

**所需模块**：`BaseManager<T>` + `TimerMgr` + `UIMgr` + `PoolMgr` + `EventCenter`

**功能**：每日登录奖励、连续登录奖励、补签功能

```csharp
// 核心思路：
// 1. 记录上次登录时间
// 2. 判断是否跨天，发放每日奖励
// 3. 连续登录天数累计
// 4. 用TimerMgr检查每日重置
```

---

### 组合10：排行榜系统

**所需模块**：`UWQResMgr` + `UIMgr` + `BaseManager<T>` + `EventCenter`

**功能**：本地排行榜、网络排行榜、好友排行

```csharp
// 核心思路：
// 1. 本地排行：保存分数到PlayerPrefs，排序显示
// 2. 网络排行：从服务器获取排名数据
// 3. 更新排名时发送事件刷新UI
```

---

## 模块搭配速查表

| 功能需求 | 需要组合的模块 | 关键类 |
|----------|----------------|--------|
| 敌人AI | PoolMgr + TimerMgr + EventCenter + MonoMgr | Enemy, EnemyStateMachine |
| 成就系统 | BaseManager + EventCenter + UIMgr + ResMgr + PoolMgr | AchievementManager, AchievementPanel |
| 技能系统 | TimerMgr + EventCenter + UIMgr + MusicMgr + PoolMgr | SkillManager, SkillIcon |
| 存档系统 | BaseManager + EventCenter + UIMgr + EncryptionUtil | SaveManager, SavePanel |
| 商城系统 | BaseManager + UIMgr + ResMgr + EventCenter + PoolMgr | ShopManager, ShopPanel |
| 任务系统 | BaseManager + EventCenter + UIMgr + TimerMgr | QuestManager, QuestPanel |
| 新手引导 | EventCenter + UIMgr + PoolMgr + TimerMgr | GuideManager, GuideStep |
| 公告系统 | UWQResMgr + UIMgr + ResMgr | NoticeManager, NoticePanel |
| 每日奖励 | BaseManager + TimerMgr + UIMgr + PoolMgr | DailyManager, DailyPanel |
| 排行榜 | UWQResMgr + UIMgr + BaseManager | RankManager, RankPanel |
| 背包系统 | BaseManager + UIMgr + PoolMgr + ResMgr | InventoryManager, ItemCell |
| 宠物/伙伴 | PoolMgr + TimerMgr + EventCenter + UIMgr | PetManager, PetPanel |
| 装备系统 | BaseManager + UIMgr + PoolMgr + EventCenter | EquipmentManager, EquipmentPanel |
| 聊天系统 | UWQResMgr + UIMgr + EventCenter | ChatManager, ChatPanel |
| 邮件系统 | UWQResMgr + UIMgr + BaseManager + PoolMgr | MailManager, MailPanel |

---

## 进阶技巧

### 技巧1：模块间的数据传递

```csharp
// 好的做法：通过事件传递数据
EventCenter.Instance.EventTrigger<int>(E_GameEvent.E_Score_Add, score);

// 不好的做法：直接引用
public class Player : MonoBehaviour
{
    public UIManager uiManager;  // 强耦合
}
```

### 技巧2：资源的预加载

```csharp
public class ResourcePreloader : MonoBehaviour
{
    public void PreloadAll()
    {
        // 预加载UI资源
        for (int i = 0; i < 5; i++)
        {
            var panel = PoolMgr.Instance.GetObj<UIPanel>("UIPanel");
            PoolMgr.Instance.PushObj(panel);
        }
        
        // 预加载音效
        MusicMgr.Instance.LoadAudioClip("bgm_main");
        MusicMgr.Instance.LoadAudioClip("attack");
    }
}
```

### 技巧3：状态管理

```csharp
// 使用单例管理游戏状态
public class GameStateManager : BaseManager<GameStateManager>
{
    public GameState CurrentState { get; private set; }
    
    public void ChangeState(GameState newState)
    {
        GameState oldState = CurrentState;
        CurrentState = newState;
        
        // 发送状态变化事件
        EventCenter.Instance.EventTrigger<GameState, GameState>(E_GameEvent.E_State_Changed, oldState, newState);
    }
}

public enum GameState
{
    Menu,
    Playing,
    Paused,
    GameOver,
    Loading
}
```

### 技巧4：时间管理

```csharp
// 游戏时间（受暂停影响）
float gameTime = Time.time;

// 真实时间（不受暂停影响）
float realTime = Time.unscaledTime;

// 帧间隔（受暂停影响）
float deltaTime = Time.deltaTime;

// 真实帧间隔（不受暂停影响）
float unscaledDeltaTime = Time.unscaledDeltaTime;

// 在TimerMgr中使用
TimerMgr.Instance.CreateTimer(
    isRealTime: true,   // true=真实时间，false=游戏时间
    allTime: 5000,
    overCallBack: () => { }
);
```

---

## 结语

这篇进阶教程展示了如何使用框架的多个模块组合来实现完整的游戏功能。记住这些关键点：

1. **模块组合**：没有孤立的功能，多个模块需要协同工作
2. **事件驱动**：优先使用事件系统进行模块间通信
3. **对象池**：频繁创建的对象一定要用对象池
4. **状态管理**：复杂逻辑用状态机来管理
5. **资源管理**：合理预加载，及时卸载

继续探索框架的更多功能，你将能够制作出完整的游戏！